<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ebook Reader - Kane's Bookstore</title>
    <meta name="description" content="Secure ebook reader with NFT-gated access for Kane's Bookstore digital books.">

    <!-- Kane's Bookstore Styles -->
    <link rel="stylesheet" href="assets/css/kanes-bookstore.css">

    <!-- External Dependencies -->
    <script src="https://unpkg.com/pdf-js-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/ethers@6.8.0/dist/ethers.umd.min.js"></script>

    <!-- Reader-specific styles -->
    <style>
        .ebook-reader {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #1a1a1a;
            color: #ffffff;
        }

        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
        }

        .reader-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #ffffff;
            color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .reader-footer {
            padding: 12px 20px;
            background: #2d2d2d;
            border-top: 1px solid #404040;
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            position: relative;
            max-width: 800px;
        }

        .pdf-canvas {
            width: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .pdf-watermark {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.3);
            font-family: monospace;
            pointer-events: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .access-validation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f8fafc;
            padding: 20px;
            color: #1f2937;
        }

        .validation-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .validation-message {
            text-align: center;
            max-width: 400px;
            color: #1f2937;
        }

        .validation-message h2 {
            color: #111827;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .validation-message p {
            color: #4b5563;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .validation-details {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #374151;
        }

        .validation-details p {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .validation-details span {
            font-weight: 600;
            color: #111827;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .reader-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .reader-tools {
            display: flex;
            gap: 12px;
        }

        .btn-nav,
        .btn-tool {
            background: #404040;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-nav:hover,
        .btn-tool:hover {
            background: #525252;
        }

        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-back {
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .brand {
            font-weight: 600;
            font-size: 18px;
        }

        .wallet-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .page-info {
            font-size: 14px;
            color: #d1d5db;
        }

        .progress-text {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #374151;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div id="ebook-reader" class="ebook-reader">
        <!-- Access Validation Overlay -->
        <div id="access-validation" class="access-validation">
            <div class="validation-icon">üîê</div>
            <div class="validation-message">
                <h2>Validating Access</h2>
                <p>Checking NFT ownership...</p>
                <div class="validation-details">
                    <p>Wallet: <span id="validation-wallet">Validating...</span></p>
                    <p>Required: <span id="required-collection">Kane's Premium Collection</span></p>
                    <p>Book: <span id="book-title">Digital Marketing Mastery</span></p>
                </div>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Main Reader Interface -->
        <div id="reader-interface" class="reader-interface" style="display: none;">
            <!-- Header -->
            <div class="reader-header">
                <div class="header-left">
                    <button onclick="goBack()" class="btn-back">‚Üê Back</button>
                    <span class="brand">Kane's Bookstore</span>
                </div>
                <div class="header-right">
                    <span class="wallet-indicator">üîí <span id="reader-wallet"></span></span>
                </div>
            </div>

            <!-- Content Area -->
            <div class="reader-content">
                <div id="pdf-viewer" class="pdf-viewer">
                    <div id="pdf-loading" class="pdf-loading"
                        style="display: flex; justify-content: center; align-items: center; height: 400px;">
                        <div class="loading-spinner"></div>
                    </div>
                    <canvas id="pdf-canvas" class="pdf-canvas" style="display: none;"></canvas>
                    <div id="pdf-watermark" class="pdf-watermark"></div>
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="reader-footer">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="progress-text">
                    Progress: <span id="progress-percentage">0%</span>
                </div>

                <div class="reader-controls">
                    <div class="nav-controls">
                        <button id="prev-btn" onclick="previousPage()" class="btn-nav" disabled>‚è™</button>
                        <span class="page-info">
                            üìñ Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                        </span>
                        <button id="next-btn" onclick="nextPage()" class="btn-nav">‚è©</button>
                    </div>

                    <div class="reader-tools">
                        <button onclick="zoomOut()" class="btn-tool">üîç-</button>
                        <button onclick="zoomIn()" class="btn-tool">üîç+</button>
                        <button onclick="toggleFullscreen()" class="btn-tool">‚õ∂</button>
                        <button onclick="showSettings()" class="btn-tool">‚öôÔ∏è</button>
                        <button onclick="showDemoControls()" class="btn-tool" style="background: #3b82f6;">üé≠</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Denied Screen -->
        <div id="access-denied" class="access-validation" style="display: none;">
            <div class="validation-icon">‚ùå</div>
            <div class="validation-message">
                <h2>Access Denied</h2>
                <p>No qualifying NFT found in your wallet</p>
                <div class="validation-details">
                    <p>Wallet: <span id="denied-wallet">Not connected</span></p>
                    <p>Required: <span id="denied-collection">Kane's Premium Collection</span></p>
                    <p>Contract: <span id="denied-contract">0x742d35Cc6634C0532925a3b8D1c6F0de</span></p>
                    <p>Your wallet does not contain any NFTs from the required collection.</p>
                </div>
                <div class="access-actions" style="display: flex; gap: 12px; margin-top: 20px;">
                    <button onclick="viewCollection()" class="btn btn-secondary">View Collection</button>
                    <button onclick="buyBook()" class="btn btn-primary">Buy Book</button>
                </div>

                <!-- Demo State Switcher -->
                <div
                    style="margin-top: 30px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">üé≠ Demo Controls</h4>
                    <p style="font-size: 14px; margin-bottom: 10px; color: #1e40af;">Try different access states:</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="switchToGranted()" class="btn btn-primary"
                            style="font-size: 12px; padding: 6px 12px;">‚úÖ Grant Access</button>
                        <button onclick="switchToDenied()" class="btn btn-secondary"
                            style="font-size: 12px; padding: 6px 12px;">‚ùå Deny Access</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reader Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Background Color:</label>
                    <select id="bg-color" onchange="changeBackground()">
                        <option value="white">White</option>
                        <option value="sepia">Sepia</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Font Size:</label>
                    <input type="range" id="font-size" min="12" max="24" value="16" onchange="changeFontSize()">
                    <span id="font-size-value">16px</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Controls Modal -->
    <div id="demo-controls-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé≠ Demo Controls</h2>
                <button class="modal-close" onclick="closeDemoControls()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #6b7280; margin-bottom: 15px;">Switch between different NFT access states to see
                        how the ebook reader behaves:</p>
                </div>

                <div style="display: grid; gap: 15px;">
                    <div
                        style="padding: 15px; border: 2px solid #10b981; border-radius: 8px; background: rgba(16, 185, 129, 0.1);">
                        <h4 style="color: #10b981; margin-bottom: 8px;">‚úÖ Access Granted</h4>
                        <p style="font-size: 14px; color: #374151; margin-bottom: 10px;">User has the required NFT and
                            can read the book</p>
                        <button onclick="switchToGranted()" class="btn btn-primary" style="width: 100%;">Switch to
                            Granted State</button>
                    </div>

                    <div
                        style="padding: 15px; border: 2px solid #ef4444; border-radius: 8px; background: rgba(239, 68, 68, 0.1);">
                        <h4 style="color: #ef4444; margin-bottom: 8px;">‚ùå Access Denied</h4>
                        <p style="font-size: 14px; color: #374151; margin-bottom: 10px;">User doesn't have the required
                            NFT</p>
                        <button onclick="switchToDenied()" class="btn btn-secondary" style="width: 100%;">Switch to
                            Denied State</button>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                    <h4 style="color: #374151; margin-bottom: 8px;">üîó URL Parameters</h4>
                    <p style="font-size: 12px; color: #6b7280;">You can also manually change the URL:</p>
                    <ul style="font-size: 12px; color: #6b7280; margin: 8px 0; padding-left: 20px;">
                        <li><code>?nft=true</code> or <code>?nft=granted</code> - Access granted</li>
                        <li><code>?nft=false</code> or <code>?nft=denied</code> - Access denied</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/kanes-bookstore.js"></script>

    <script>
        // Global variables
        let currentPage = 1;
        let totalPages = 1;
        let pdfDocument = null;
        let sessionToken = null;
        let walletAddress = null;
        let zoomLevel = 1.0;
        let bookId = 'digital-marketing-mastery';
        let requiredCollection = "Kane's Premium Collection";
        let contractAddress = "0x742d35Cc6634C0532925a3b8D1c6F0de";

        // Initialize reader
        async function initializeReader() {
            try {
                // Get parameters from URL
                const urlParams = new URLSearchParams(window.location.search);
                sessionToken = urlParams.get('session');
                bookId = urlParams.get('book') || bookId;
                const nftStatus = urlParams.get('nft'); // 'true', 'false', 'granted', 'denied'

                // For demo purposes, we'll simulate different states based on URL parameter
                console.log('üé≠ Demo Mode: NFT Status =', nftStatus);

                // Show demo state indicator
                showDemoStateIndicator(nftStatus);

                // Always start with validation screen
                await validateAccess(nftStatus);

            } catch (error) {
                console.error('Reader initialization failed:', error);
                showAccessDenied('Failed to initialize reader');
            }
        }

        // Show current demo state
        function showDemoStateIndicator(nftStatus) {
            const hasNFT = nftStatus === 'true' || nftStatus === 'granted' || nftStatus === 'demo';
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: ${hasNFT ? '#10b981' : '#ef4444'};
                color: white;
                padding: 8px 20px;
                text-align: center;
                font-size: 14px;
                font-weight: 600;
                z-index: 999;
            `;
            indicator.innerHTML = `
                üé≠ DEMO MODE: ${hasNFT ? '‚úÖ NFT Access Granted' : '‚ùå NFT Access Denied'} 
                <span style="opacity: 0.8; font-weight: normal;">
                    ${hasNFT ? '(User has qualifying NFT)' : '(User lacks required NFT)'}
                </span>
            `;
            document.body.appendChild(indicator);

            // Adjust body padding to account for indicator
            document.body.style.paddingTop = '40px';
        }

        // Validate NFT access
        async function validateAccess(nftStatus) {
            try {
                showAccessValidation();

                // Simulate validation process (in real implementation, this would call the API)
                setTimeout(async () => {
                    try {
                        // Determine if user has NFT based on URL parameter
                        const hasNFT = nftStatus === 'true' || nftStatus === 'granted' || nftStatus === 'demo';

                        if (hasNFT) {
                            // ‚úÖ ACCESS GRANTED - User has the required NFT
                            console.log('‚úÖ NFT Access Granted - Loading book...');
                            walletAddress = "0x742d35Cc6634C0532925a3b8D1c6F0de123456789";
                            await loadBook();
                        } else {
                            // ‚ùå ACCESS DENIED - User doesn't have the required NFT
                            console.log('‚ùå NFT Access Denied - No qualifying NFT found');
                            walletAddress = "0x1234567890abcdef1234567890abcdef12345678";
                            showAccessDenied('No qualifying NFT found in your wallet');
                        }
                    } catch (error) {
                        console.error('Access validation failed:', error);
                        showAccessDenied('Validation failed');
                    }
                }, 2000);

            } catch (error) {
                console.error('Access validation failed:', error);
                showAccessDenied('Validation failed');
            }
        }

        // Load book content
        async function loadBook() {
            try {
                // Show reader interface
                showReaderInterface();

                // For demo purposes, we'll create a simple PDF with sample content
                // In real implementation, this would fetch the actual book content
                await loadSamplePDF();

            } catch (error) {
                console.error('Book loading failed:', error);
                showAccessDenied('Failed to load book');
            }
        }

        // Load sample PDF (demo implementation)
        async function loadSamplePDF() {
            try {
                // Create a simple canvas-based "PDF" for demo
                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');

                // Set canvas size
                canvas.width = 800;
                canvas.height = 1000;

                // Simulate total pages
                totalPages = 10;
                document.getElementById('total-pages').textContent = totalPages;

                // Load first page
                await loadPage(1);

                hideLoading();

            } catch (error) {
                console.error('Sample PDF loading failed:', error);
                hideLoading();
            }
        }

        // Load specific page
        async function loadPage(pageNumber) {
            try {
                showLoading();

                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw sample content
                ctx.fillStyle = '#000000';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Digital Marketing Mastery', canvas.width / 2, 100);

                ctx.font = '16px Arial';
                ctx.fillText(`Chapter ${pageNumber}`, canvas.width / 2, 150);

                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                const content = [
                    'This is a sample page content for demonstration purposes.',
                    'In a real implementation, this would display the actual',
                    'PDF content using PDF.js library.',
                    '',
                    'The content would be loaded from the server after',
                    'verifying NFT ownership and generating a secure',
                    'reading session token.',
                    '',
                    'Key features:',
                    '‚Ä¢ Secure content delivery',
                    '‚Ä¢ Watermarked pages',
                    '‚Ä¢ Progress tracking',
                    '‚Ä¢ Cross-device sync',
                    '‚Ä¢ Download prevention'
                ];

                content.forEach((line, index) => {
                    ctx.fillText(line, 50, 220 + (index * 25));
                });

                // Update current page
                currentPage = pageNumber;
                document.getElementById('current-page').textContent = currentPage;

                // Update navigation buttons
                document.getElementById('prev-btn').disabled = currentPage <= 1;
                document.getElementById('next-btn').disabled = currentPage >= totalPages;

                // Update progress
                updateProgress();

                // Save reading progress
                saveProgress();

                hideLoading();

                // Update watermark
                updateWatermark();

            } catch (error) {
                console.error('Page loading failed:', error);
                hideLoading();
            }
        }

        // Navigation functions
        function nextPage() {
            if (currentPage < totalPages) {
                loadPage(currentPage + 1);
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                loadPage(currentPage - 1);
            }
        }

        // Zoom functions
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.25, 3.0);
            const canvas = document.getElementById('pdf-canvas');
            canvas.style.transform = `scale(${zoomLevel})`;
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.25, 0.5);
            const canvas = document.getElementById('pdf-canvas');
            canvas.style.transform = `scale(${zoomLevel})`;
        }

        // Progress tracking
        function updateProgress() {
            const progressPercentage = Math.round((currentPage / totalPages) * 100);
            document.getElementById('progress-percentage').textContent = progressPercentage + '%';
            document.getElementById('progress-fill').style.width = progressPercentage + '%';
        }

        async function saveProgress() {
            try {
                console.log(`Saving progress: Page ${currentPage} of ${totalPages}`);
                // In real implementation, this would save to the server
            } catch (error) {
                console.error('Failed to save progress:', error);
            }
        }

        // UI state management
        function showAccessValidation() {
            document.getElementById('access-validation').style.display = 'flex';
            document.getElementById('reader-interface').style.display = 'none';
            document.getElementById('access-denied').style.display = 'none';

            // Update validation info
            document.getElementById('validation-wallet').textContent = walletAddress || 'Validating...';
            document.getElementById('required-collection').textContent = requiredCollection;
            document.getElementById('book-title').textContent = 'Digital Marketing Mastery';
        }

        function showReaderInterface() {
            document.getElementById('access-validation').style.display = 'none';
            document.getElementById('reader-interface').style.display = 'flex';
            document.getElementById('access-denied').style.display = 'none';

            // Update reader info
            if (walletAddress) {
                document.getElementById('reader-wallet').textContent =
                    `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
            }
        }

        function showAccessDenied(message) {
            document.getElementById('access-validation').style.display = 'none';
            document.getElementById('reader-interface').style.display = 'none';
            document.getElementById('access-denied').style.display = 'flex';

            // Update denied wallet address if available
            if (walletAddress) {
                document.getElementById('denied-wallet').textContent =
                    `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
            }
        }

        function showLoading() {
            document.getElementById('pdf-loading').style.display = 'flex';
            document.getElementById('pdf-canvas').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('pdf-loading').style.display = 'none';
            document.getElementById('pdf-canvas').style.display = 'block';
        }

        function updateWatermark() {
            const watermark = document.getElementById('pdf-watermark');
            if (walletAddress) {
                watermark.textContent = `${walletAddress.substring(0, 10)}...${walletAddress.substring(32)}`;
            }
        }

        // Enhanced navigation functions
        function goBack() {
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');
            const accessType = urlParams.get('access');

            // Smart back navigation based on how user arrived
            if (source === 'confirmation') {
                // Go back to confirmation page
                const confirmationParams = new URLSearchParams({
                    access: accessType,
                    source: 'reader'
                });
                window.location.href = `02-order-confirmation.html?${confirmationParams.toString()}`;
            } else if (source === 'product' || !source) {
                // Go back to product detail page
                window.location.href = '01-product-detail-page.html';
            } else if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '../index.html';
            }
        }

        function goToStore() {
            // Navigate to main store page
            window.location.href = '../index.html';
        }

        function goToProductPage() {
            // Navigate to this book's product page
            window.location.href = '01-product-detail-page.html';
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function showDemoControls() {
            document.getElementById('demo-controls-modal').style.display = 'flex';
        }

        function closeDemoControls() {
            document.getElementById('demo-controls-modal').style.display = 'none';
        }

        function changeBackground() {
            const bg = document.getElementById('bg-color').value;
            const content = document.querySelector('.reader-content');

            switch (bg) {
                case 'sepia':
                    content.style.background = '#f4f1e8';
                    content.style.color = '#5c4d2c';
                    break;
                case 'dark':
                    content.style.background = '#1a1a1a';
                    content.style.color = '#e5e5e5';
                    break;
                default:
                    content.style.background = '#ffffff';
                    content.style.color = '#000000';
            }
        }

        function changeFontSize() {
            const size = document.getElementById('font-size').value;
            document.getElementById('font-size-value').textContent = size + 'px';
            // In real implementation, this would adjust the PDF rendering
        }

        function viewCollection() {
            window.location.href = `https://opensea.io/collection/kanes-premium-collection`;
        }

        function buyBook() {
            window.location.href = '01-product-detail-page.html';
        }

        // Demo state switching functions
        function switchToGranted() {
            const url = new URL(window.location);
            url.searchParams.set('nft', 'granted');
            window.location.href = url.toString();
        }

        function switchToDenied() {
            const url = new URL(window.location);
            url.searchParams.set('nft', 'denied');
            window.location.href = url.toString();
        }

        // Content protection
        function disableRightClick() {
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
            });
        }

        function disableTextSelection() {
            document.addEventListener('selectstart', function (e) {
                e.preventDefault();
            });
        }

        function disableKeyboardShortcuts() {
            document.addEventListener('keydown', function (e) {
                // Disable Ctrl+S, Ctrl+P, F12, etc.
                if ((e.ctrlKey && (e.key === 's' || e.key === 'p')) || e.key === 'F12') {
                    e.preventDefault();
                }
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', function (e) {
            switch (e.key) {
                case 'ArrowLeft':
                    previousPage();
                    break;
                case 'ArrowRight':
                    nextPage();
                    break;
                case 'Escape':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    break;
            }
        });

        // Initialize when page loads with enhanced flow context
        document.addEventListener('DOMContentLoaded', function () {
            initializeReaderWithContext();
            disableRightClick();
            disableTextSelection();
            disableKeyboardShortcuts();
        });

        function initializeReaderWithContext() {
            // Get flow context from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const accessType = urlParams.get('access') || 'demo';
            const source = urlParams.get('source') || 'direct';
            const walletAddress = urlParams.get('wallet');
            const demo = urlParams.get('demo');

            // Update page title and context based on access type
            if (accessType === 'nft') {
                document.title = 'NFT Reader - Kane\'s Bookstore';
                updateReaderContext('üé® NFT Access Verified', 'Reading with NFT privileges');
            } else if (accessType === 'purchase') {
                document.title = 'Premium Reader - Kane\'s Bookstore';
                updateReaderContext('üí≥ Premium Access', 'Reading purchased content');
            } else if (demo) {
                document.title = 'Demo Reader - Kane\'s Bookstore';
                updateReaderContext('üé≠ Demo Mode', 'Exploring reader features');
            }

            // Add source indicator for users coming from confirmation page
            if (source === 'confirmation') {
                showWelcomeMessage('Welcome back! Continue reading from where you left off.');
            }

            // Initialize reader with enhanced access checking
            initializeReader();
            checkAccessWithContext();
        }

        function updateReaderContext(title, subtitle) {
            // Add context indicator to reader header
            const header = document.querySelector('.reader-header');
            if (header) {
                const contextIndicator = document.createElement('div');
                contextIndicator.style.cssText = `
                    background: rgba(16, 185, 129, 0.1);
                    color: #10b981;
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    border: 1px solid rgba(16, 185, 129, 0.2);
                    margin-left: 1rem;
                `;
                contextIndicator.innerHTML = `<span style="margin-right: 0.5rem;">${title}</span><span style="opacity: 0.7;">${subtitle}</span>`;
                header.appendChild(contextIndicator);
            }
        }

        function showWelcomeMessage(message) {
            const welcomeBar = document.createElement('div');
            welcomeBar.style.cssText = `
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                color: white;
                padding: 1rem;
                text-align: center;
                font-weight: 600;
                position: relative;
                overflow: hidden;
                z-index: 1000;
            `;
            welcomeBar.innerHTML = `
                <div style="position: relative; z-index: 1;">
                    üëã ${message}
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        margin-left: 1rem;
                        cursor: pointer;
                        opacity: 0.8;
                        font-size: 1.2rem;
                    ">√ó</button>
                </div>
            `;
            document.body.insertBefore(welcomeBar, document.body.firstChild);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (welcomeBar.parentElement) {
                    welcomeBar.remove();
                }
            }, 5000);
        }

        function checkAccessWithContext() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessType = urlParams.get('access');
            const walletAddress = urlParams.get('wallet');
            const nftGranted = urlParams.get('nft') === 'true' || urlParams.get('nft') === 'granted';
            const demo = urlParams.get('demo');

            if (demo === 'true' || nftGranted) {
                // Direct access - show reader immediately
                simulateGrantedAccess('demo');
            } else if (accessType === 'nft' && walletAddress) {
                // NFT access with wallet already connected
                simulateNFTVerification(walletAddress);
            } else if (accessType === 'purchase') {
                // Purchase access - immediate access
                simulateGrantedAccess('purchase');
            } else {
                // Default access validation
                // Use existing initializeReader logic
            }
        }

        function simulateNFTVerification(walletAddress) {
            showAccessValidation();

            // Update validation message
            const validationElement = document.querySelector('.validation-message');
            if (validationElement) {
                validationElement.innerHTML = `
                    <div class="validation-icon">üîÑ</div>
                    <h2>Verifying NFT Access</h2>
                    <p>Checking wallet ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)} for qualifying NFTs...</p>
                    <div class="loading-spinner"></div>
                `;
            }

            // Simulate verification delay
            setTimeout(() => {
                simulateGrantedAccess('nft');
            }, 2000);
        }

        function simulateGrantedAccess(accessType) {
            showReaderInterface();

            // Load the book content
            loadBook();

            // Show success notification
            let message = 'Access granted! Enjoy your reading experience.';
            if (accessType === 'nft') {
                message = 'üé® NFT verified! You now have free access to this premium content.';
            } else if (accessType === 'purchase') {
                message = 'üí≥ Purchase confirmed! Thank you for your support.';
            }

            showNotification('‚úÖ Access Granted', message);
        }

        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                z-index: 1000;
                font-weight: 600;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${title}</div>
                <div style="opacity: 0.9; font-size: 0.9rem;">${message}</div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>

    <!-- Analytics -->
    <script>
        // Track reading session
        gtag('event', 'ebook_session_start', {
            book_id: bookId,
            wallet_address: walletAddress,
            access_method: 'nft_validation'
        });
    </script>
</body>

</html>